!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Idiomorph=t()}(this,(function(){"use strict";let e=new Set;function t(e,o,i){if(i.head.block){let n=e.querySelector("head"),r=o.querySelector("head");if(n&&r){let d=l(r,n,i);return void Promise.all(d).then((function(){t(e,o,Object.assign(i,{head:{block:!1,ignore:!0}}))}))}}if("innerHTML"===i.morphStyle)return r(o,e,i),e.children;if("outerHTML"===i.morphStyle||null==i.morphStyle){let t=function(e,t,n){let r;r=e.firstChild;let o=r,l=0;for(;r;){let e=s(r,t,n);e>l&&(o=r,l=e),r=r.nextSibling}return o}(o,e,i),r=t?.previousSibling,l=t?.nextSibling,d=n(e,t,i);return t?function(e,t,n){let r=[],o=[];for(;null!=e;)r.push(e),e=e.previousSibling;for(;r.length>0;){let e=r.pop();o.push(e),t.parentElement.insertBefore(e,t)}o.push(t);for(;null!=n;)r.push(n),o.push(n),n=n.nextSibling;for(;r.length>0;)t.parentElement.insertBefore(r.pop(),t.nextSibling);return o}(r,d,l):[]}throw"Do not understand how to morph style "+i.morphStyle}function n(e,t,n){if(!n.ignoreActive||e!==document.activeElement){if(null==t){if(!1===n.callbacks.beforeNodeRemoved(e))return;return e.remove(),n.callbacks.afterNodeRemoved(e),null}if(a(e,t)){if(!1===n.callbacks.beforeNodeMorphed(e,t))return;return e instanceof HTMLHeadElement&&n.head.ignore||(e instanceof HTMLHeadElement&&"morph"!==n.head.style?l(t,e,n):(!function(e,t){let n=e.nodeType;if(1===n){const n=e.attributes,r=t.attributes;for(const e of n)t.getAttribute(e.name)!==e.value&&t.setAttribute(e.name,e.value);for(const n of r)e.hasAttribute(n.name)||t.removeAttribute(n.name)}8!==n&&3!==n||t.nodeValue!==e.nodeValue&&(t.nodeValue=e.nodeValue);if(e instanceof HTMLInputElement&&t instanceof HTMLInputElement&&"file"!==e.type)t.value=e.value||"",o(e,t,"value"),o(e,t,"checked"),o(e,t,"disabled");else if(e instanceof HTMLOptionElement)o(e,t,"selected");else if(e instanceof HTMLTextAreaElement&&t instanceof HTMLTextAreaElement){let n=e.value;n!==t.value&&(t.value=n),t.firstChild&&t.firstChild.nodeValue!==n&&(t.firstChild.nodeValue=n)}}(t,e),r(t,e,n))),n.callbacks.afterNodeMorphed(e,t),e}if(!1===n.callbacks.beforeNodeRemoved(e))return;if(!1===n.callbacks.beforeNodeAdded(t))return;return e.parentElement.replaceChild(t,e),n.callbacks.afterNodeAdded(t),n.callbacks.afterNodeRemoved(e),t}}function r(e,t,r){let o,l=e.firstChild,i=t.firstChild;for(;l;){if(o=l,l=o.nextSibling,null==i){if(!1===r.callbacks.beforeNodeAdded(o))return;t.appendChild(o),r.callbacks.afterNodeAdded(o),b(r,o);continue}if(d(o,i,r)){n(i,o,r),i=i.nextSibling,b(r,o);continue}let a=f(e,t,o,i,r);if(a){i=u(i,a,r),n(a,o,r),b(r,o);continue}let s=c(e,t,o,i,r);if(s)i=u(i,s,r),n(s,o,r),b(r,o);else{if(!1===r.callbacks.beforeNodeAdded(o))return;t.insertBefore(o,i),r.callbacks.afterNodeAdded(o),b(r,o)}}for(;null!==i;){let e=i;i=i.nextSibling,p(e,r)}}function o(e,t,n){e[n]!==t[n]&&(e[n]?t.setAttribute(n,e[n]):t.removeAttribute(n))}function l(e,t,n){let r=[],o=[],l=[],i=[],d=n.head.style,a=new Map;for(const t of e.children)a.set(t.outerHTML,t);for(const e of t.children){let t=a.has(e.outerHTML),r=n.head.shouldReAppend(e),u=n.head.shouldPreserve(e);t||u?r?o.push(e):(a.delete(e.outerHTML),l.push(e)):"append"===d?r&&(o.push(e),i.push(e)):!1!==n.head.shouldRemove(e)&&o.push(e)}i.push(...a.values());let u=[];for(const e of i){let o=document.createRange().createContextualFragment(e.outerHTML).firstChild;if(!1!==n.callbacks.beforeNodeAdded(o)){if(o.href||o.src){let e=null,t=new Promise((function(t){e=t}));o.addEventListener("load",(function(){e()})),u.push(t)}t.appendChild(o),n.callbacks.afterNodeAdded(o),r.push(o)}}for(const e of o)!1!==n.callbacks.beforeNodeRemoved(e)&&(t.removeChild(e),n.callbacks.afterNodeRemoved(e));return n.head.afterHeadMorphed(t,{added:r,kept:l,removed:o}),u}function i(){}function d(e,t,n){return null!=e&&null!=t&&(e.nodeType===t.nodeType&&e.tagName===t.tagName&&(""!==e.id&&e.id===t.id||g(n,e,t)>0))}function a(e,t){return null!=e&&null!=t&&(e.nodeType===t.nodeType&&e.tagName===t.tagName)}function u(e,t,n){for(;e!==t;){let t=e;e=e.nextSibling,p(t,n)}return b(n,t),t.nextSibling}function f(e,t,n,r,o){let l=g(o,n,t);if(l>0){let t=r,i=0;for(;null!=t;){if(d(n,t,o))return t;if(i+=g(o,t,e),i>l)return null;t=t.nextSibling}}return null}function c(e,t,n,r,o){let l=r,i=n.nextSibling,d=0;for(;null!=l;){if(g(o,l,e)>0)return null;if(a(n,l))return l;if(a(i,l)&&(d++,i=i.nextSibling,d>=2))return null;l=l.nextSibling}return l}function s(e,t,n){return a(e,t)?.5+g(n,e,t):0}function p(e,t){b(t,e),!1!==t.callbacks.beforeNodeRemoved(e)&&(e.remove(),t.callbacks.afterNodeRemoved(e))}function h(e,t){return!e.deadIds.has(t)}function m(t,n,r){return(t.idMap.get(r)||e).has(n)}function b(t,n){let r=t.idMap.get(n)||e;for(const e of r)t.deadIds.add(e)}function g(t,n,r){let o=t.idMap.get(n)||e,l=0;for(const e of o)h(t,e)&&m(t,e,r)&&++l;return l}function v(e,t){let n=e.parentElement,r=e.querySelectorAll("[id]");for(const e of r){let r=e;for(;r!==n&&null!=r;){let n=t.get(r);null==n&&(n=new Set,t.set(r,n)),n.add(e.id),r=r.parentElement}}}function y(e,t){let n=new Map;return v(e,n),v(t,n),n}return{morph:function(e,n,r={}){e instanceof Document&&(e=e.documentElement),"string"==typeof n&&(n=function(e){let t=new DOMParser,n=e.replace(/<svg(\s[^>]*>|>)([\s\S]*?)<\/svg>/gim,"");if(n.match(/<\/html>/)||n.match(/<\/head>/)||n.match(/<\/body>/)){let r=t.parseFromString(e,"text/html");if(n.match(/<\/html>/))return r.generatedByIdiomorph=!0,r;{let e=r.firstChild;return e?(e.generatedByIdiomorph=!0,e):null}}{let n=t.parseFromString("<body><template>"+e+"</template></body>","text/html").body.querySelector("template").content;return n.generatedByIdiomorph=!0,n}}(n));let o=function(e){if(null==e){return document.createElement("div")}if(e.generatedByIdiomorph)return e;if(e instanceof Node){const t=document.createElement("div");return t.append(e),t}{const t=document.createElement("div");for(const n of[...e])t.append(n);return t}}(n),l=function(e,t,n){return{target:e,newContent:t,config:n,morphStyle:n.morphStyle,ignoreActive:n.ignoreActive,idMap:y(e,t),deadIds:new Set,callbacks:Object.assign({beforeNodeAdded:i,afterNodeAdded:i,beforeNodeMorphed:i,afterNodeMorphed:i,beforeNodeRemoved:i,afterNodeRemoved:i},n.callbacks),head:Object.assign({style:"merge",shouldPreserve:function(e){return"true"===e.getAttribute("im-preserve")},shouldReAppend:function(e){return"true"===e.getAttribute("im-re-append")},shouldRemove:i,afterHeadMorphed:i},n.head)}}(e,o,r);return t(e,o,l)}}}));
